{% extends 'layouts/general-layout.html' %}
{% load static %}
{% load widget_tweaks %}
{% block title %}Editar Perfil{% endblock title %}

{% block banner %}
<section class="relative w-full h-[320px] md:h-[420px] lg:h-[500px] overflow-hidden ">

  <!-- Imagen -->
  <img 
    src="{% static 'img/banner6.webp' %}" 
    alt="Banner principal del sitio"
    fetchpriority="high"
    loading="eager"
    class="w-full h-full object-cover mt-3"
  >

  <!-- Contenido centrado -->
  <div class="absolute inset-0 flex items-center justify-center bg-black/40">
    <h1 class="text-white text-4xl md:text-6xl font-extrabold tracking-wide drop-shadow-xl">
      Edita tu Perfil
    </h1>
  </div>

</section>
{% endblock banner %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">

  <!-- Formulario principal -->
  <div class="bg-white rounded-3xl shadow-2xl border border-orange-100 overflow-hidden transition-all duration-300 hover:shadow-3xl">

    <!-- Header con avatar centrado -->
    <div class="bg-gradient-to-r from-orange-500 to-amber-500 p-8 text-center relative">
      <!-- Elemento decorativo -->
      <div class="absolute top-0 left-0 w-32 h-32 bg-white/10 rounded-full -translate-x-16 -translate-y-16"></div>
      <div class="absolute bottom-0 right-0 w-40 h-40 bg-white/5 rounded-full translate-x-20 translate-y-20"></div>
      
      <div class="relative z-10">
        <!-- Avatar con inicial del usuario -->
        <div class="relative inline-block mb-4">
          <div class="w-28 h-28 rounded-full bg-gradient-to-br from-white/20 to-white/10 border-4 border-white shadow-2xl flex items-center justify-center mx-auto backdrop-blur-sm">
            <span class="text-white text-4xl font-black drop-shadow-lg">
              {% if user.first_name %}
                {{ user.first_name|first|upper }}
              {% else %}
                {{ user.username|first|upper }}
              {% endif %}
            </span>
          </div>
          <!-- Indicador de estado -->
          <div class="absolute bottom-3 right-3 w-6 h-6 bg-green-500 rounded-full border-2 border-white"></div>
        </div>
        
        <!-- Informaci√≥n del usuario -->
        <div class="space-y-2">
          <h2 class="text-2xl font-bold text-white mb-1 tracking-tight">
            {% if user.first_name or user.last_name %}
              {{ user.first_name }} {{ user.last_name }}
            {% else %}
              {{ user.username }}
            {% endif %}
          </h2>
          <p class="text-white/90 text-lg">@{{ user.username }}</p>
          <p class="text-white/80 text-sm mt-2">Edita tu informaci√≥n a continuaci√≥n</p>
        </div>
      </div>
    </div>

    <!-- Mensajes de Django mejorados -->
    {% if messages %}
      <div class="px-6 pt-6">
        {% for message in messages %}
          <div class="flex items-start gap-3 p-4 mb-4 rounded-xl 
            {% if message.tags == 'success' %} bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 text-green-800
            {% elif message.tags == 'error' %} bg-gradient-to-r from-red-50 to-rose-50 border border-red-200 text-red-800
            {% elif message.tags == 'warning' %} bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200 text-amber-800
            {% else %} bg-gradient-to-r from-gray-50 to-slate-50 border border-gray-200 text-gray-800 {% endif %}">
            <div class="text-xl mt-0.5">
              {% if message.tags == 'success' %} ‚úÖ
              {% elif message.tags == 'error' %} ‚ùå
              {% elif message.tags == 'warning' %} ‚ö†Ô∏è
              {% else %} ‚ÑπÔ∏è {% endif %}
            </div>
            <div class="flex-1">
              <p class="font-medium">{{ message }}</p>
              {% if message.tags == 'success' %}
                <p class="text-sm opacity-80 mt-1">Redirigiendo a tu perfil...</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate class="p-8 space-y-8">
      {% csrf_token %}

      <!-- Errores generales -->
      {% if form.non_field_errors %}
        <div class="bg-gradient-to-r from-red-50 to-rose-50 border-l-4 border-red-500 p-4 rounded-lg">
          <div class="flex items-start">
            <div class="text-red-500 text-xl mr-3">‚ö†Ô∏è</div>
            <div>
              <h4 class="font-bold text-red-700">Error en el formulario</h4>
              {% for error in form.non_field_errors %}
                <p class="text-red-600 text-sm mt-1">{{ error }}</p>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Campos del formulario organizados -->
      <div class="grid md:grid-cols-2 gap-6">
        {% for field in form %}
          <div class="space-y-2 {% if field.name == 'biografia' %}md:col-span-2{% endif %}">
            <label class="block text-sm font-bold text-orange-700">
              {{ field.label }}
              {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
            </label>
            
            {% if field.name == 'avatar' %}
              <!-- Campo de avatar especial con preview din√°mico -->
              <div class="flex flex-col md:flex-row items-start md:items-center gap-4 p-4 bg-gradient-to-br from-orange-50 to-amber-50 rounded-2xl border border-orange-200">
                <div class="flex-shrink-0">
                  <div class="relative">
                    <div class="w-24 h-24 rounded-full border-3 border-orange-300 bg-white flex items-center justify-center overflow-hidden shadow-md">
                      {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" 
                             alt="Avatar actual" 
                             class="w-full h-full object-cover"
                             id="avatar-preview">
                      {% else %}
                        <div id="avatar-preview" class="w-full h-full bg-gradient-to-br from-orange-200 to-amber-200 flex items-center justify-center">
                          <span class="text-3xl font-bold text-orange-600">
                            {% if user.first_name %}
                              {{ user.first_name|first|upper }}
                            {% else %}
                              {{ user.username|first|upper }}
                            {% endif %}
                          </span>
                        </div>
                      {% endif %}
                    </div>
                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-blue-500 rounded-full border-2 border-white" title="Cambiar imagen">
                      <span class="absolute inset-0 flex items-center justify-center text-white text-xs">+</span>
                    </div>
                  </div>
                </div>
                <div class="flex-1">
                  <div class="space-y-2">
                    {{ field|add_class:"w-full px-4 py-3 bg-white border border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gradient-to-r file:from-orange-500 file:to-amber-500 file:text-white hover:file:from-orange-600 hover:file:to-amber-600" }}
                    <p class="text-xs text-gray-600">
                      üì∑ Sube una imagen cuadrada (m√°x. 2MB). Formatos: JPG, PNG, GIF.
                      {% if user.avatar %}
                      <br>üîÑ Tu imagen actual se mostrar√° hasta que subas una nueva.
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            {% elif field.name == 'biografia' %}
              <!-- Textarea para biograf√≠a con contador -->
              <div class="space-y-2">
                <div class="relative">
                  {{ field|add_class:"w-full px-4 py-3 bg-white border border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition min-h-[120px] resize-y"|attr:"rows:4" }}
                  <div class="absolute bottom-3 right-3 text-sm">
                    <span id="bio-counter" class="text-orange-600 font-medium">0/500</span>
                  </div>
                </div>
                <p class="text-xs text-gray-600 flex items-center gap-1">
                  <span>‚úçÔ∏è</span> Comparte algo sobre ti y tus mascotas. Este texto aparecer√° en tu perfil p√∫blico.
                </p>
              </div>
            {% else %}
              <!-- Campos normales con estilo mejorado -->
              <div class="group">
                {{ field|add_class:"w-full px-4 py-3 bg-white border border-orange-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-400 focus:border-transparent transition group-hover:border-orange-400" }}
                {% if field.name == 'email' and field.value %}
                  <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                    <span>üìß</span> Usaremos este email para notificaciones importantes.
                  </p>
                {% endif %}
              </div>
            {% endif %}
            
            <!-- Errores del campo -->
            {% if field.errors %}
              <div class="text-red-600 text-sm mt-1 flex items-center gap-1">
                <span>‚ö†Ô∏è</span> {{ field.errors|striptags }}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Botones de acci√≥n -->
      <div class="flex flex-wrap gap-4 justify-between items-center pt-8 border-t border-orange-200">
        <div class="flex flex-wrap gap-3">
          <a href="{% url 'usuarios:perfil' %}" 
             class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-800 font-bold rounded-full shadow-md hover:shadow-lg transition-all duration-300 hover:-translate-y-0.5">
            <span>‚Üê</span> Volver al perfil
          </a>
        </div>

        <div class="flex flex-wrap gap-3">
          <button type="reset" 
                  class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5">
            <span>üîÑ</span>
            Restablecer
          </button>
          <button type="submit" 
                  class="flex items-center gap-2 px-8 py-3.5 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white font-bold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 group">
            <span class="group-hover:scale-110 transition-transform">üíæ</span>
            Guardar cambios
          </button>
        </div>
      </div>

    </form>

  </div>

  <!-- Enlace para eliminar cuenta -->
  <div class="mt-8 bg-gradient-to-r from-red-50 to-rose-50 rounded-2xl border border-red-200 p-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-red-500 to-rose-500 rounded-lg flex items-center justify-center">
          <span class="text-white text-lg">‚ö†Ô∏è</span>
        </div>
        <div>
          <h3 class="text-lg font-bold text-red-700 mb-1">Zona de peligro</h3>
          <p class="text-red-600/80 text-sm">Esta acci√≥n eliminar√° permanentemente tu cuenta y todos tus datos.</p>
          <p class="text-red-500/60 text-xs mt-1">‚ö†Ô∏è Esta acci√≥n no se puede deshacer.</p>
        </div>
      </div>
      <a href="{% url 'usuarios:eliminar_cuenta' %}" 
         class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-red-500 to-rose-500 hover:from-red-600 hover:to-rose-600 text-white font-bold rounded-full shadow-md hover:shadow-lg transition-all duration-300 hover:-translate-y-0.5 whitespace-nowrap">
        <span>üóëÔ∏è</span>
        Eliminar cuenta
      </a>
    </div>
  </div>

</div>

<!-- Script para funcionalidades adicionales -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Vista previa del avatar
  const avatarInput = document.querySelector('input[name="avatar"]');
  const avatarPreview = document.getElementById('avatar-preview');
  
  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validar tama√±o m√°ximo (2MB)
        if (file.size > 2 * 1024 * 1024) {
          alert('El archivo es demasiado grande. M√°ximo 2MB.');
          this.value = '';
          return;
        }
        
        // Validar tipo de archivo
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          alert('Formato no v√°lido. Usa JPG, PNG o GIF.');
          this.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          // Mostrar la nueva imagen
          avatarPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="Nueva imagen de perfil">`;
          avatarPreview.classList.remove('bg-gradient-to-br', 'from-orange-200', 'to-amber-200');
        };
        reader.readAsDataURL(file);
      } else {
        // Si no hay archivo, restaurar la inicial
        const firstName = "{{ user.first_name|first|upper|default:user.username|first|upper }}";
        avatarPreview.innerHTML = `<span class="text-3xl font-bold text-orange-600">${firstName}</span>`;
        avatarPreview.classList.add('bg-gradient-to-br', 'from-orange-200', 'to-amber-200');
        avatarPreview.classList.remove('object-cover');
      }
    });
  }

  // Contador de caracteres para biograf√≠a
  const bioTextarea = document.querySelector('textarea[name="biografia"]');
  const bioCounter = document.getElementById('bio-counter');
  
  if (bioTextarea && bioCounter) {
    function updateCounter() {
      const length = bioTextarea.value.length;
      bioCounter.textContent = `${length}/500`;
      
      if (length > 450) {
        bioCounter.classList.remove('text-orange-600', 'text-amber-600');
        bioCounter.classList.add('text-red-600');
      } else if (length > 400) {
        bioCounter.classList.remove('text-orange-600', 'text-red-600');
        bioCounter.classList.add('text-amber-600');
      } else {
        bioCounter.classList.remove('text-amber-600', 'text-red-600');
        bioCounter.classList.add('text-orange-600');
      }
    }
    
    bioTextarea.addEventListener('input', updateCounter);
    updateCounter(); // Inicializar contador
  }

  // Efecto de foco en campos
  const inputs = document.querySelectorAll('input, textarea, select');
  inputs.forEach(input => {
    const parent = input.closest('.group') || input.parentElement;
    input.addEventListener('focus', function() {
      parent.classList.add('ring-2', 'ring-orange-200', 'ring-opacity-50');
    });
    input.addEventListener('blur', function() {
      parent.classList.remove('ring-2', 'ring-orange-200', 'ring-opacity-50');
    });
  });

  // Redirecci√≥n autom√°tica en mensaje de √©xito
  const successMessage = document.querySelector('.bg-gradient-to-r.from-green-50');
  if (successMessage) {
    setTimeout(function() {
      window.location.href = "{% url 'usuarios:perfil' %}";
    }, 2000);
  }
});
</script>

<style>
/* Estilos personalizados para el input file */
input[type="file"]::file-selector-button {
  background: linear-gradient(to right, #f97316, #f59e0b);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  margin-right: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

input[type="file"]::file-selector-button:hover {
  background: linear-gradient(to right, #ea580c, #d97706);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
}

/* Mejor scrollbar para textarea */
textarea::-webkit-scrollbar {
  width: 8px;
}

textarea::-webkit-scrollbar-track {
  background: #fed7aa;
  border-radius: 4px;
}

textarea::-webkit-scrollbar-thumb {
  background: #f97316;
  border-radius: 4px;
}

textarea::-webkit-scrollbar-thumb:hover {
  background: #ea580c;
}

/* Animaci√≥n para el avatar */
#avatar-preview {
  transition: all 0.3s ease;
}

#avatar-preview:hover {
  transform: scale(1.05);
}
</style>
{% endblock content %}